
name: Release

on:
  push:
    branches: [ "main" ]
    tags:
      - v*

env:
  IMAGE_NAME: fonsecabarreto/nest-app

jobs:
  pushToDockerHub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: docker build . --file Dockerfile --tag $IMAGE_NAME
      - run: echo "${{secrets.DOCKERHUB_PASSWORD}}" | docker login -u ${{secrets.DOCKERHUB_USERNAME}} --password-stdin
      - run: docker push $IMAGE_NAME 
  deploy:
    needs: pushToDockerHub
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v3
        - name: Executing remote command
          uses: appleboy/ssh-action@master
          with:
            PORT: 22
            HOST: ${{ secrets.HOST }}
            USERNAME: ${{ secrets.USERNAME }}
            KEY: ${{ secrets.SSHKEY }}
            envs: IMAGE_NAME
            script: |
              echo $IMAGE_NAME
              # Remove old container
              docker stop $(echo $IMAGE_NAME)
              docker rm $(echo $IMAGE_NAME)
              # Run a new container from a new image
              docker run -d \
              --restart always \
              -p 8080:3000 \
              --name $(echo $IMAGE_NAME) \
              $(echo $IMAGE_NAME)
