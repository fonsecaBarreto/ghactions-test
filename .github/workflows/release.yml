
name: Release

on:
  push:
    branches: [ "main" ]
    tags:
      - v*

env:
  IMAGE_NAME: nest-app
  REGISTRY_NAME: ghactions-test-registry

jobs:
  pushToDORegistry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build image
        run: docker build . --file Dockerfile --tag $IMAGE_NAME
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
            token: ${{ secrets.DO_ACCESS_TOKEN }}
      - name: Remove old images from Container Registry
        uses: ripplr-io/docr-image-remove@v1
        with:
          image_repository: $IMAGE_NAME
          buffer_size: 0
      - name: push image to digitalocean
        run: |
          doctl registry login
          docker tag $IMAGE_NAME registry.digitalocean.com/$REGISTRY_NAME/$IMAGE_NAME
          docker push registry.digitalocean.com/$REGISTRY_NAME/$IMAGE_NAME
  deploy:
    needs: pushToDORegistry
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v3
        - name: Executing remote command
          uses: appleboy/ssh-action@master
          with:
            PORT: 22
            HOST: ${{ secrets.HOST }}
            USERNAME: ${{ secrets.USERNAME }}
            KEY: ${{ secrets.SSHKEY }}
            envs: IMAGE_NAME,REGISTRY
            script: |
              echo $IMAGE_NAME
              # Stop running container
              docker stop $(echo $IMAGE_NAME)
              # Remove old container
              docker rm $(echo $IMAGE_NAME)
              # Run a new container from a new image
              docker run -d \
              --restart always \
              -p 8080:3000 \
              --name $(echo $IMAGE_NAME) \
